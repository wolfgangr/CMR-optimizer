## Log of exemplary workflow
### What we want in the end
Maps from different sources properly layered and manageable the qgis way  
_(sorry for the pixelation of maps w/ unknown (C) state )_  

![example](./QGIS-history-layers-example.jpg)

### `Shepherd_0042.jpg`  
**Source Map**, see https://archive.org/details/HistoricalAtlasWilliamR.Shepherd/page/n1/mode/2up  
Historical Atlas by William R. Shepherd, pg 70/71  
- marked as "opensource" by archive.org
- good quality scan - original close to 40 Mpixel (scaled to 30 % here)
- typical layout of historic atlas, typical continental coverage of europe
- fine graticule
- clear background
- book spline already corrected

![source map](./Shepherd_0042.jpg)

- load source image (jp2) into GIMP, crop, export; optionally coulour enhance, scale
- Launch **QGIS georeferencer** and load this file as raster.
- choose some preliminary CRS that might roughly fit (e. g. `laea` aka *lambert azimuthal equal area* or `eqdc` aka *eqidistant conic*, centered roughly near the area)
- may or may not be the same as in QGIS main canvas
- put **match points at the lat/lon graticule** in the map and enter their **coordinates manually** in **WGS 84** aka **EPSG:4326**
- in the example, I selected all crosspoints along the edges of the map and a 10 x 10 deg raster inbetween
- usually you want to get it done with a fraction of 40 - without loosing precision - that's why we are here


#### Shepherd_0042.jpg.aux.xml
(skd of colour statistic, generated by QGIS georeferencer, not relevant for our case here)
### Shepherd_0042.jpg.points
**point file** containing our **matchpoints** generated by the georeferencer from Shepherd_0042.jpg  
**the focus of our interest**
#### Shepherd_0042.jpg.points_40
copy of points file with as much as 40 matchpoints, as used through most of the walkthrough
#### Shepherd_0042.jpg.points_4
copy of points file with as little as 4 matchpoints, as used for the final step

manually reformated for better readability, this looks like:
```
#CRS:
PROJCRS["unknown",
  BASEGEOGCRS["unknown",
    DATUM["Unknown based on WGS 84 ellipsoid", ELLIPSOID["WGS 84",6378137,298.257223563,LENGTHUNIT["metre",1],ID["EPSG",7030]]],
    PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8901]]
  ],
  CONVERSION["unknown",
    METHOD["Bonne",ID["EPSG",9827]],
    PARAMETER["Latitude of natural origin",50,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8801]],
    PARAMETER["Longitude of natural origin",20,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8802]],
    PARAMETER["False easting",0,LENGTHUNIT["metre",1],ID["EPSG",8806]],
    PARAMETER["False northing",0,LENGTHUNIT["metre",1],ID["EPSG",8807]]
  ],
  CS[Cartesian,2],
  AXIS["(E)",east,ORDER[1],LENGTHUNIT["metre",1,ID["EPSG",9001]]],
  AXIS["(N)",north,ORDER[2],LENGTHUNIT["metre",1,ID["EPSG",9001]]]
]

                   mapX   ,                    mapY   ,             sourceX   ,             sourceY  ,enable,              dX   ,                dY   ,    residual
-1264808.11747819161973894,   725798.94674882607068866,  598.62514756747646061,  -485.60985421198654421, 1, -0.3295319391729663 , -0.55583132316644424, 0.64617316467650965
 1264808.11747819161973894,   725798.94674882607068866, 1486.58348090080994552,  -489.12652087865319572, 1,  0.3295319391729663 ,  0.55583132316621686, 0.64617316467631414
-1805300.44668449461460114, -1430455.52371982322074473,  404.85681423414291658, -1252.94652087865347312, 1,  0.23087274608474218,  0.38941992773584388, 0.45271415374659946
 1805300.44668449461460114, -1430455.52371982322074473, 1673.67014756747630599, -1260.33152087865346402, 1, -0.23087274608496955, -0.38941992773584388, 0.45271415374671542
```

In the original file, all the WKT stuff is on a single line, following the ` #CRS:` label.  
Note that the WKT is reproduced from and thus roughly equivalent to the "good old" `proj` notation:  
`+proj=bonne +lat_1=50 +lon_0=20 +ellps=WGS84 +units=m +no_defs +type=crs`

The CSV block with the point parameters is without spaces and matches the table as visible in the georeferencer's GUI.  
`mapX`, `mapY` are the coordinates in the CRS provided - even if we entered them manually as plain integer values in `WGS 84` CRS.  
`sourceX`, `sourceY` are the pixel positions where we placed our match points in the GUI.  

Note that if we change our georef target CRS, `mapX`, `mapY` will change, even if the underlying lat/lon does not change.  
Thus we may watch out for rounding errors and numerical artefacts upon switching target CRS.

# cutting edge ...
## Get some feeling for atlas CRS
TBD: links to proj list, mapfoobatr comparison, pdf ESRI and USGS
image in diercke don't dara to steal copyright

## Playing with Georef settings
... and try to understand them ...  
We find **circular parallels** on our map. Thus we might head for `eqdc` aka *equidistant conic*.  
A closer look reveals slightly **bent meridians**, too, so we'd go for `LAEA` *(equal area azimuthal)* or it's bretheren instead.  
Searching QGIS standard CRS list, we find **EPSG:3575** *"europe North pole LAEA"* as close enough and use this as **georef target CRS** to start.

### Helmert
Helmert transformation just allows **shift, scale and rotation**.  
Georeferencer calculates more than **80 Pixel deviation** - clearly visible as red lines in the georef UI:

![](Shepherd_0042-Georef-Helmert.jpg)  

In the `geotiff` generated by the georeferencer, we find our image rotated  
*(note: I converted the geotif to jpg for memory and bandwith reasons.  )*  
With sth like `exiftool`, we could extract the parameters of mapping from the tif's pixel to target CRS, but this does not help us much in our endeavour.  

![](Shepherd_0042_EPSG3575_EuropeLAEA_Helmert.jpg)  

### Polynomial 1
1st degree polynomials allow different scales for x and y.  
Pixel deviation falls to 52 - still quite some long needles in the map:  

![](Shepherd_0042-Georef-Poly1.jpg)  

There is little visual difference to helmert in the geotif, but when we toggle between them in an image viewer, we may watch the change of ratio:  

![](Shepherd_0042_EPSG3575_EuropeLAEA_Poly1.jpg)  

Showing both layers (Helmert and Poly 1) in QGIS, we notice  
- both images are heavily bent the same way
- the different ratio
- the maps' graticules by far mismatch the correct graticule indicated by the magenta overlay lines
- the red dots are far off the crossings in the graticules
- coast lines are far off their correct positions as visible by the orange overlay
  
![](Shepherd_0042_QGIS_Helmert-P1.jpg)  


### Polynomial 2

When we switch to **Polynomial 2**, pixel deviation drastically falls from 52 to 3.5.  
In normal scale, the red needles are barely visible in the UI any more.

![](Shepherd_0042-Georef-Poly2.jpg)

In the `geotiff`, the bending of the image gets obvious.  
It 'somehow looks like' wrapped conus, but not raelly.  
We might take this as clue that what we are relly looking for might be between laea and eqdc.

![](Shepherd_0042_EPSG3575_EuropeLAEA_Poly2.jpg)

### Polynomial 3

3rd order polynoms allow for even more tweaks like *"blowing"* up the image like a ballon.  
However, compared to poly 2, we see pixel deviation fall from 3.5 to 3.2 merely.  The difference is close to invisible in the UI.
Thus, for the current case, we might stick with the poly 2, if it were not for didactical reasons.  
E.g. for maps much larger than Europe, or distortions from uncorrected book splines, things may differ.

The `geotiff` looks quite similiar to the poly 2 case. Only by toggling or overlaying the images, we notice a slight *"wiggling"* of the corners.

![](Shepherd_0042_EPSG3575_EuropeLAEA_Poly3.jpg)

In QGIS (Georeferncer window still active), we find the graticule's crossings neatly placed at the red dots.  
However, we may notice that beyond the dots, towards the edges of the map, the direction of the graticule is misaligned a bit.  
If we play the same game with a lower number of match points, we have to expect larger distortions, again.

I played with different project CRS in QGIS.  
The screenshot below is with ESRI:54024 aka "World_Bonne".  
We find the map projected to near - but not exact - rectangular shape.  
Thus we may conclude that we are quite close to original map producer's CRS.  
If we were able to match this exactly, we might set our georeferencer to low order projections (helmert, poly1), requiring only a small number of matchpoints and introducing no artificial distortions.

![](Shepherd_0042_QGIS_P3.jpg)

### Thin Plate Spline

Just for curiosity, and we have such a large number of matching points already at hand, we may switch to TPS aka _"rubber sheet"_ mode.  
Pixel deviation falls to some negative exponential I'd consider as zero.  

![](Shepherd_0042-Georef-TPS.jpg)

In QGIS, we may already notice some typical signs of **"overfitting"** i.e. considerable bents at margins and corners and small scale "wiggling" inside the picture.  

![](Shepherd_0042_QGIS_TPS.jpg)

================~~~~~~~~~~~~~~~~~~~~~~~~~


![](QGIS_LAEA-poly3_vs_myBonne-50-20-Helmert.jpg)


![](Shepherd_0042_myBonne-50-20-Helmert-4pt-Poly1.jpg)
![](Shepherd_0042_myBonne-50-20-Helmert.jpg)
![](Shepherd_0042_myBonne-50-20-P1.jpg)
![](Shepherd_0042_myBonne-50-20-P2.jpg)
![](Shepherd_0042_myBonne-50-20-P3.jpg)


